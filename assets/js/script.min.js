function Game() {}

Game.prototype = {

    constructor: Game,

    players: [],

    getPlayers: function() {
        return this.players;
    },

    setPlayers: function(player1, player2) {
        for (var k in arguments) {
            this.players.push(arguments[k]);
        }
    },

    getPlayerByRole: function(role) {
        var players = this.getPlayers();
        for (var k in players) {
            if(players[k].role === role) {
                return players[k];
            }
        }
    },

    startGame: function() {
        this.initPlayers();
        this.initShooter();
    },

    initPlayers: function () {
        this.setPlayers(new Player("Пользователь", "user"), new Player("Компьютер", "comp"));

        var players = this.getPlayers();

        for (var k in players) {
            var player = players[k];
            player.initPlayer();
        }
    },

    initShooter: function () {
        var grids = document.getElementById('gamefield_comp').getElementsByTagName('span'),
            $self = this,
            intelligentHit,
            intelligent = false;

        for(var t=0; t < grids.length; t++) {
            grids[t].addEventListener("click", handleShoot);
        }

        function handleShoot() {
            var gridId = this.getAttribute('id'),
                index = gridId.indexOf('_'),
                coord = gridId.substring(0, index);

            anyliseHit(coord, 'user');
        }

        function anyliseHit(coord, gamer) {
            var gamerObj = $self.getPlayerByRole(gamer),
                enemyObj,
                enemyFleet,
                seaGrid = coord + '_',
                loggerStr;

            if (gamer === 'user') {
                enemyObj = $self.getPlayerByRole('comp');
                seaGrid += 'comp';
            } else {
                enemyObj = $self.getPlayerByRole('user');
                seaGrid += 'user';
            }

            enemyFleet = enemyObj.getFleet();

            gamerObj.setShootCounter();

            loggerStr = gamerObj.getName()
                +". "
                +"Выстрел №"
                +gamerObj.getShootCounter()
                +". ";

            var checker = 0;

            outer:
                for (var m in enemyFleet) {
                    var coords = enemyFleet[m].coords;

                    for (var n in coords) {
                        var trigger = coords[n].indexOf(coord);
                        if (trigger !== -1) { // if comp ship is hit
                            document.getElementById(seaGrid).setAttribute("class", "killed");
                            document.getElementById(seaGrid).removeEventListener("click", handleShoot);

                            if (coords[n].length === 1) {
                                document.getElementById("countShoot").innerHTML+="<p>"
                                    +loggerStr
                                    +enemyFleet[m].name
                                    +" убит!</p>";
                                    intelligent = false;

                            } else {
                                document.getElementById("countShoot").innerHTML+="<p>"
                                    +loggerStr
                                    +enemyFleet[m].name
                                    +" ранен!</p>";
                                    intelligent = true;
                                    intelligentHit = coord;

                            }
                            
                            scrollLogger();
                            
                            coords[n].splice(trigger, 1);

                            for (var m in enemyFleet) {
                                var coords = enemyFleet[m].coords;

                                for (var n in coords) {
                                    checker+= coords[n].length;
                                }
                            }

                            if (checker === 0) {
                                finishGame(gamerObj);
                            }

                            if (gamer === 'comp') {
                                compShooter(intelligent);
                            }
                            return true;
                            break outer;
                        }
                    }
                }

            document.getElementById("countShoot").innerHTML+="<p>" + loggerStr + "Промах!</p>";
            document.getElementById(seaGrid).setAttribute("class", "disabled");
            document.getElementById(seaGrid).removeEventListener("click", handleShoot);
            scrollLogger();

            if (gamer === 'user') {
                compShooter();
            }
        }

        function compShooter(param) {
            var compHitCoord = getHitCoord(param);
            anyliseHit(compHitCoord, 'comp');
        }

        function scrollLogger() {    
            var objDiv = document.getElementById("countShoot");
            objDiv.scrollTop = objDiv.scrollHeight;
        }

        function getHitCoord(param) {
            var enemyGrids = $self.getPlayerByRole('comp').getEnemyGrids(),
                resIndex,
                result;
                
                if (param) {
                    var intelligentParseCoord = intelligentHit.split(":"),
                    x = parseInt(intelligentParseCoord[0]),
                    y = parseInt(intelligentParseCoord[1]),
                    freeDots = [x+1+":"+y, x-1+":"+y, x+":"+y+1, x+":"+y-1];

                    for (var m=0; m < freeDots.length; i++) {
                        resIndex = enemyGrids.indexOf(freeDots[m]);

                        if(resIndex !==-1) {
                            break;
                        }
                    }
                }
                else {
                    resIndex = Math.floor(Math.random() * ((enemyGrids.length-1) + 1)); // array index
                }

            result = enemyGrids[resIndex];
            
            $self.getPlayerByRole('comp').removeEnemyGrids(resIndex);

            return result;
        }

        function finishGame(gamer) {
            document.getElementById('body').setAttribute("style", "visibility:hidden;");
            alert("Игра окончена! Выйграл "+gamer.getName()+" за "+gamer.getShootCounter()+" выстрелов!");
            document.getElementById('reloadGame').setAttribute("style", "display:inline-block");
            document.getElementById('reloadGame').addEventListener("click", reloader);
        }

        function reloader() {
            location.reload();
        }

    }
};
function Player (name, role) {

    this.name = name;

    this.role = role;

    this.shootCounter = 0;

    this.fleet = {
        fourGrid: {
            weight:4,
            quantity:1,
            name: "Четырехпалубник",
            coords: []
        },
        threeGrid: {
            weight: 3,
            quantity: 2,
            name: "Трехпалубник",
            coords: []
        },
        twoGrid: {
            weight: 2,
            quantity: 3,
            name: "Двухпалубник",
            coords: []
        },
        oneGrid: {
            weight: 1,
            quantity: 4,
            name: "Однопалубник",
            coords: []
        }
    };

    this.seaCoords = [];

    this.enemyGrids = [];

    this.x = 10;

    this.y = 10;

    this.getName = function() {
        return this.name;
    };

    this.getRole = function() {
        return this.role;
    };

    this.getShootCounter = function() {
        return this.shootCounter;
    };

    this.setShootCounter = function() {
        this.shootCounter++;
    };

    this.getFleet = function() {
        return this.fleet;
    };

    this.getX = function() {
        return this.x;
    };

    this.getY = function() {
        return this.y;
    };

    this.getSeaCoords = function() {
      return this.seaCoords;
    };

    this.addSeaCoords = function(i) {
        this.seaCoords.push(i);
    };

    this.removeSeaCoords = function(i) {
        this.seaCoords.splice(i,1);
    };

    this.getEnemyGrids = function() {
        return this.enemyGrids;
    };

    this.addEnemyGrids = function(i) {
        this.enemyGrids.push(i);
    };

    this.removeEnemyGrids = function(i) {
        this.enemyGrids.splice(i,1);
    };

    this.initPlayer = function() {
        this.createGameField();
        this.locateFleet();
    };

    this.createGameField = function() {
         var xSize = this.getX(),
             ySize = this.getY();

        for (var i = 1; i <= xSize; i++) {
            for (var j = 1; j <= ySize; j++) {
                document.getElementById('gamefield_' + this.getRole()).innerHTML += '<span class="seagrid" id="'+ i + ':'+ j + "_" + this.getRole()+'"></span>';
                this.addSeaCoords(i+":"+j);

                if (this.getRole() === 'comp') {
                    this.addEnemyGrids(i+":"+j);
                }
            }
        }
    };

    this.locateFleet = function() {
        var $self = this,
            fleet = $self.getFleet(),
            k, obj,
            busyCoordsArray = [];

        // run over fleet object
        for (k in fleet) {
            obj = fleet[k];

            // run over ships on fleet
            for (var t = 0; t < obj.quantity; t++) {
                var shipCoords = generateCoords(); // result coords for ship
                obj.coords.push(shipCoords[0]);

                for (var m in shipCoords[1]) {
                    var trigger = busyCoordsArray.indexOf(shipCoords[1][m]);
                    if (trigger === -1) {
                        busyCoordsArray.push(shipCoords[1][m]);
                    }
                }

                cleanSeaCoords(shipCoords);

                if($self.getRole() === 'user') {
                    drawFleet(shipCoords[0]);
                }
            }
        }

        // generate coords
        function generateCoords() {
            var result = [],
                validatePosition = false;

            do {
                // create ship coords and busy coords
                var createdPosition = createStartPosition(),
                    tempCoords = createCoords(createdPosition);

                // validate coords for ship location
                validatePosition = checkCoords(tempCoords);
            }
            while(validatePosition === false);

            if (validatePosition === true) {
                result.push(tempCoords[0], tempCoords[1]);
            }
            return result;
        }

        // randomise start position
        function createStartPosition() {
            var direction = Math.floor(Math.random() * 2), // 0 - draw ship horizontal; 1 - draw ship vertical
                posIndex = Math.floor(Math.random() * (($self.getSeaCoords().length-1) + 1)), // array index
                position = $self.getSeaCoords()[posIndex]; // value on this index

            return [position, direction];
        }

        // calculate ship coords
        function createCoords(startData) {
            var tempShipCoords = [],
                tempBusyCoords = createBusyCoords(startData),
                startArr = startData[0].split(":"),
                xPos = parseInt(startArr[0]),
                yPos = parseInt(startArr[1]),
                dir = startData[1];

            for (var s=0; s < obj.weight; s++) {
                switch (dir) {
                    case 1:
                        var x = xPos,
                            y = yPos + s;

                        tempShipCoords.push(x + ":" + y); // values array
                        break;
                    case 0:
                        var x = xPos + s,
                            y = yPos;

                        tempShipCoords.push(x + ":" + y); // values array
                        break;
                }
            }
            return [tempShipCoords, tempBusyCoords];
        }

        function createBusyCoords(i) {
            var tempDeadCoords=[],
                startArr = i[0].split(":"),
                x = parseInt(startArr[0]),
                y = parseInt(startArr[1]),
                dir = i[1];// 0 - draw ship horizontal; 1 - draw ship vertical

            for (var s=0; s < obj.weight; s++) {
                switch (dir) {
                    case 1:
                        if(x>1){
                            tempDeadCoords.push(x-1+":"+(y+s));
                        }
                        if(x<10) tempDeadCoords.push(x+1+":"+(y+s));
                        if(s==0 && x>=1 && y>1){
                            tempDeadCoords.push(x+":"+(y-1));
                            if(x>1){
                                tempDeadCoords.push(x-1+":"+(y-1));
                            }
                            if(x<10) tempDeadCoords.push(x+1+":"+(y-1));
                        }
                        if(s === obj.weight-1 && y<10-s){
                            tempDeadCoords.push(x+":"+((y+s)+1));
                            if(x>1){
                                tempDeadCoords.push((x-1)+":"+((y+s)+1));
                            }
                            if(x<10) tempDeadCoords.push((x+1)+":"+((y+s)+1));
                        }
                        break;

                    case 0:
                        if(y>1){
                            tempDeadCoords.push((x+s)+":"+(y-1));
                        }
                        if(y<10) tempDeadCoords.push((x+s)+":"+(y+1));
                        if(s === 0 && x>1 && y>=1){
                            tempDeadCoords.push(x-1+":"+(y));
                            if(y>1){
                                tempDeadCoords.push((x-1)+":"+(y-1));
                            }
                            if(y<10) tempDeadCoords.push((x-1)+":"+(y+1));
                        }
                        if(s === obj.weight-1 && x<10-s){
                            tempDeadCoords.push((x+s)+1+":"+(y));
                            if(y>1){
                                tempDeadCoords.push((x+s)+1+":"+(y-1));
                            }
                            if(y<10)tempDeadCoords.push((x+s)+1+":"+(y+1));
                        }
                        break;
                }
            }
            return tempDeadCoords;
        }

        // validator for created coords
        function checkCoords(data) {
            var validator = false,
                testShipDots = [],
                testBusyDots = [],
                valid_ship,
                valid_around;

            for (var k in data[0]) {
                var coord = $self.getSeaCoords().indexOf(data[0][k]),
                    busyDot = busyCoordsArray.indexOf(data[0][k]); //value

                testShipDots.push(coord);
                testBusyDots.push(busyDot);
            }

            var is_valid = function(n) { return n == -1; };

            valid_ship = testShipDots.some(is_valid);
            valid_around = testBusyDots.some(is_valid);

            if (valid_ship === false && valid_around === true) {
                validator = true;
            } else {
                validator = false;
            }

            return validator;
        }

        // delete busy coords from seaCoords Array
        function cleanSeaCoords(data) {
            var shipCoords = data[0],
                busyCoords = data[1];

            deleter(shipCoords,busyCoords);
        }

        function deleter() {
            for (var m in arguments) {
                for (var k in arguments[m]) {
                    var coordsArray = $self.getSeaCoords(),
                        dot = coordsArray.indexOf(arguments[m][k]);

                    if (dot !== -1) $self.removeSeaCoords(dot);
                }
            }
        }

        // draw fleet on seafield
        function drawFleet(i) {

            for (var key in i) {
                var gridId = i[key]+"_"+$self.getRole();
                document.getElementById(gridId).setAttribute("class", "sheep");
            }
        }
    };
}
(function(){

    var game = new Game();

    game.startGame();

}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkdhbWUuQ2xhc3MuanMiLCJQbGF5ZXIuQ2xhc3MuanMiLCJhcHAuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzFNQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM3VEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoic2NyaXB0Lm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImZ1bmN0aW9uIEdhbWUoKSB7fVxuXG5HYW1lLnByb3RvdHlwZSA9IHtcblxuICAgIGNvbnN0cnVjdG9yOiBHYW1lLFxuXG4gICAgcGxheWVyczogW10sXG5cbiAgICBnZXRQbGF5ZXJzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGxheWVycztcbiAgICB9LFxuXG4gICAgc2V0UGxheWVyczogZnVuY3Rpb24ocGxheWVyMSwgcGxheWVyMikge1xuICAgICAgICBmb3IgKHZhciBrIGluIGFyZ3VtZW50cykge1xuICAgICAgICAgICAgdGhpcy5wbGF5ZXJzLnB1c2goYXJndW1lbnRzW2tdKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBnZXRQbGF5ZXJCeVJvbGU6IGZ1bmN0aW9uKHJvbGUpIHtcbiAgICAgICAgdmFyIHBsYXllcnMgPSB0aGlzLmdldFBsYXllcnMoKTtcbiAgICAgICAgZm9yICh2YXIgayBpbiBwbGF5ZXJzKSB7XG4gICAgICAgICAgICBpZihwbGF5ZXJzW2tdLnJvbGUgPT09IHJvbGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcGxheWVyc1trXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBzdGFydEdhbWU6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLmluaXRQbGF5ZXJzKCk7XG4gICAgICAgIHRoaXMuaW5pdFNob290ZXIoKTtcbiAgICB9LFxuXG4gICAgaW5pdFBsYXllcnM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5zZXRQbGF5ZXJzKG5ldyBQbGF5ZXIoXCLQn9C+0LvRjNC30L7QstCw0YLQtdC70YxcIiwgXCJ1c2VyXCIpLCBuZXcgUGxheWVyKFwi0JrQvtC80L/RjNGO0YLQtdGAXCIsIFwiY29tcFwiKSk7XG5cbiAgICAgICAgdmFyIHBsYXllcnMgPSB0aGlzLmdldFBsYXllcnMoKTtcblxuICAgICAgICBmb3IgKHZhciBrIGluIHBsYXllcnMpIHtcbiAgICAgICAgICAgIHZhciBwbGF5ZXIgPSBwbGF5ZXJzW2tdO1xuICAgICAgICAgICAgcGxheWVyLmluaXRQbGF5ZXIoKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBpbml0U2hvb3RlcjogZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgZ3JpZHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ2FtZWZpZWxkX2NvbXAnKS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc3BhbicpLFxuICAgICAgICAgICAgJHNlbGYgPSB0aGlzLFxuICAgICAgICAgICAgaW50ZWxsaWdlbnRIaXQsXG4gICAgICAgICAgICBpbnRlbGxpZ2VudCA9IGZhbHNlO1xuXG4gICAgICAgIGZvcih2YXIgdD0wOyB0IDwgZ3JpZHMubGVuZ3RoOyB0KyspIHtcbiAgICAgICAgICAgIGdyaWRzW3RdLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBoYW5kbGVTaG9vdCk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBoYW5kbGVTaG9vdCgpIHtcbiAgICAgICAgICAgIHZhciBncmlkSWQgPSB0aGlzLmdldEF0dHJpYnV0ZSgnaWQnKSxcbiAgICAgICAgICAgICAgICBpbmRleCA9IGdyaWRJZC5pbmRleE9mKCdfJyksXG4gICAgICAgICAgICAgICAgY29vcmQgPSBncmlkSWQuc3Vic3RyaW5nKDAsIGluZGV4KTtcblxuICAgICAgICAgICAgYW55bGlzZUhpdChjb29yZCwgJ3VzZXInKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGFueWxpc2VIaXQoY29vcmQsIGdhbWVyKSB7XG4gICAgICAgICAgICB2YXIgZ2FtZXJPYmogPSAkc2VsZi5nZXRQbGF5ZXJCeVJvbGUoZ2FtZXIpLFxuICAgICAgICAgICAgICAgIGVuZW15T2JqLFxuICAgICAgICAgICAgICAgIGVuZW15RmxlZXQsXG4gICAgICAgICAgICAgICAgc2VhR3JpZCA9IGNvb3JkICsgJ18nLFxuICAgICAgICAgICAgICAgIGxvZ2dlclN0cjtcblxuICAgICAgICAgICAgaWYgKGdhbWVyID09PSAndXNlcicpIHtcbiAgICAgICAgICAgICAgICBlbmVteU9iaiA9ICRzZWxmLmdldFBsYXllckJ5Um9sZSgnY29tcCcpO1xuICAgICAgICAgICAgICAgIHNlYUdyaWQgKz0gJ2NvbXAnO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBlbmVteU9iaiA9ICRzZWxmLmdldFBsYXllckJ5Um9sZSgndXNlcicpO1xuICAgICAgICAgICAgICAgIHNlYUdyaWQgKz0gJ3VzZXInO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlbmVteUZsZWV0ID0gZW5lbXlPYmouZ2V0RmxlZXQoKTtcblxuICAgICAgICAgICAgZ2FtZXJPYmouc2V0U2hvb3RDb3VudGVyKCk7XG5cbiAgICAgICAgICAgIGxvZ2dlclN0ciA9IGdhbWVyT2JqLmdldE5hbWUoKVxuICAgICAgICAgICAgICAgICtcIi4gXCJcbiAgICAgICAgICAgICAgICArXCLQktGL0YHRgtGA0LXQuyDihJZcIlxuICAgICAgICAgICAgICAgICtnYW1lck9iai5nZXRTaG9vdENvdW50ZXIoKVxuICAgICAgICAgICAgICAgICtcIi4gXCI7XG5cbiAgICAgICAgICAgIHZhciBjaGVja2VyID0gMDtcblxuICAgICAgICAgICAgb3V0ZXI6XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgbSBpbiBlbmVteUZsZWV0KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjb29yZHMgPSBlbmVteUZsZWV0W21dLmNvb3JkcztcblxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBuIGluIGNvb3Jkcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyaWdnZXIgPSBjb29yZHNbbl0uaW5kZXhPZihjb29yZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHJpZ2dlciAhPT0gLTEpIHsgLy8gaWYgY29tcCBzaGlwIGlzIGhpdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNlYUdyaWQpLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwia2lsbGVkXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNlYUdyaWQpLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBoYW5kbGVTaG9vdCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29vcmRzW25dLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImNvdW50U2hvb3RcIikuaW5uZXJIVE1MKz1cIjxwPlwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArbG9nZ2VyU3RyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArZW5lbXlGbGVldFttXS5uYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArXCIg0YPQsdC40YIhPC9wPlwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZWxsaWdlbnQgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiY291bnRTaG9vdFwiKS5pbm5lckhUTUwrPVwiPHA+XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICtsb2dnZXJTdHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICtlbmVteUZsZWV0W21dLm5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICtcIiDRgNCw0L3QtdC9ITwvcD5cIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVsbGlnZW50ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVsbGlnZW50SGl0ID0gY29vcmQ7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsTG9nZ2VyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vcmRzW25dLnNwbGljZSh0cmlnZ2VyLCAxKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG0gaW4gZW5lbXlGbGVldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29vcmRzID0gZW5lbXlGbGVldFttXS5jb29yZHM7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbiBpbiBjb29yZHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrZXIrPSBjb29yZHNbbl0ubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoZWNrZXIgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmluaXNoR2FtZShnYW1lck9iaik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdhbWVyID09PSAnY29tcCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcFNob290ZXIoaW50ZWxsaWdlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJjb3VudFNob290XCIpLmlubmVySFRNTCs9XCI8cD5cIiArIGxvZ2dlclN0ciArIFwi0J/RgNC+0LzQsNGFITwvcD5cIjtcbiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNlYUdyaWQpLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIFwiZGlzYWJsZWRcIik7XG4gICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChzZWFHcmlkKS5yZW1vdmVFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgaGFuZGxlU2hvb3QpO1xuICAgICAgICAgICAgc2Nyb2xsTG9nZ2VyKCk7XG5cbiAgICAgICAgICAgIGlmIChnYW1lciA9PT0gJ3VzZXInKSB7XG4gICAgICAgICAgICAgICAgY29tcFNob290ZXIoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGNvbXBTaG9vdGVyKHBhcmFtKSB7XG4gICAgICAgICAgICB2YXIgY29tcEhpdENvb3JkID0gZ2V0SGl0Q29vcmQocGFyYW0pO1xuICAgICAgICAgICAgYW55bGlzZUhpdChjb21wSGl0Q29vcmQsICdjb21wJyk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBzY3JvbGxMb2dnZXIoKSB7ICAgIFxuICAgICAgICAgICAgdmFyIG9iakRpdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiY291bnRTaG9vdFwiKTtcbiAgICAgICAgICAgIG9iakRpdi5zY3JvbGxUb3AgPSBvYmpEaXYuc2Nyb2xsSGVpZ2h0O1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZ2V0SGl0Q29vcmQocGFyYW0pIHtcbiAgICAgICAgICAgIHZhciBlbmVteUdyaWRzID0gJHNlbGYuZ2V0UGxheWVyQnlSb2xlKCdjb21wJykuZ2V0RW5lbXlHcmlkcygpLFxuICAgICAgICAgICAgICAgIHJlc0luZGV4LFxuICAgICAgICAgICAgICAgIHJlc3VsdDtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocGFyYW0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGludGVsbGlnZW50UGFyc2VDb29yZCA9IGludGVsbGlnZW50SGl0LnNwbGl0KFwiOlwiKSxcbiAgICAgICAgICAgICAgICAgICAgeCA9IHBhcnNlSW50KGludGVsbGlnZW50UGFyc2VDb29yZFswXSksXG4gICAgICAgICAgICAgICAgICAgIHkgPSBwYXJzZUludChpbnRlbGxpZ2VudFBhcnNlQ29vcmRbMV0pLFxuICAgICAgICAgICAgICAgICAgICBmcmVlRG90cyA9IFt4KzErXCI6XCIreSwgeC0xK1wiOlwiK3ksIHgrXCI6XCIreSsxLCB4K1wiOlwiK3ktMV07XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbT0wOyBtIDwgZnJlZURvdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc0luZGV4ID0gZW5lbXlHcmlkcy5pbmRleE9mKGZyZWVEb3RzW21dKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYocmVzSW5kZXggIT09LTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzSW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoKGVuZW15R3JpZHMubGVuZ3RoLTEpICsgMSkpOyAvLyBhcnJheSBpbmRleFxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVzdWx0ID0gZW5lbXlHcmlkc1tyZXNJbmRleF07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgICRzZWxmLmdldFBsYXllckJ5Um9sZSgnY29tcCcpLnJlbW92ZUVuZW15R3JpZHMocmVzSW5kZXgpO1xuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZmluaXNoR2FtZShnYW1lcikge1xuICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2JvZHknKS5zZXRBdHRyaWJ1dGUoXCJzdHlsZVwiLCBcInZpc2liaWxpdHk6aGlkZGVuO1wiKTtcbiAgICAgICAgICAgIGFsZXJ0KFwi0JjQs9GA0LAg0L7QutC+0L3Rh9C10L3QsCEg0JLRi9C50LPRgNCw0LsgXCIrZ2FtZXIuZ2V0TmFtZSgpK1wiINC30LAgXCIrZ2FtZXIuZ2V0U2hvb3RDb3VudGVyKCkrXCIg0LLRi9GB0YLRgNC10LvQvtCyIVwiKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWxvYWRHYW1lJykuc2V0QXR0cmlidXRlKFwic3R5bGVcIiwgXCJkaXNwbGF5OmlubGluZS1ibG9ja1wiKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWxvYWRHYW1lJykuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHJlbG9hZGVyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIHJlbG9hZGVyKCkge1xuICAgICAgICAgICAgbG9jYXRpb24ucmVsb2FkKCk7XG4gICAgICAgIH1cblxuICAgIH1cbn07IiwiZnVuY3Rpb24gUGxheWVyIChuYW1lLCByb2xlKSB7XG5cbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuXG4gICAgdGhpcy5yb2xlID0gcm9sZTtcblxuICAgIHRoaXMuc2hvb3RDb3VudGVyID0gMDtcblxuICAgIHRoaXMuZmxlZXQgPSB7XG4gICAgICAgIGZvdXJHcmlkOiB7XG4gICAgICAgICAgICB3ZWlnaHQ6NCxcbiAgICAgICAgICAgIHF1YW50aXR5OjEsXG4gICAgICAgICAgICBuYW1lOiBcItCn0LXRgtGL0YDQtdGF0L/QsNC70YPQsdC90LjQulwiLFxuICAgICAgICAgICAgY29vcmRzOiBbXVxuICAgICAgICB9LFxuICAgICAgICB0aHJlZUdyaWQ6IHtcbiAgICAgICAgICAgIHdlaWdodDogMyxcbiAgICAgICAgICAgIHF1YW50aXR5OiAyLFxuICAgICAgICAgICAgbmFtZTogXCLQotGA0LXRhdC/0LDQu9GD0LHQvdC40LpcIixcbiAgICAgICAgICAgIGNvb3JkczogW11cbiAgICAgICAgfSxcbiAgICAgICAgdHdvR3JpZDoge1xuICAgICAgICAgICAgd2VpZ2h0OiAyLFxuICAgICAgICAgICAgcXVhbnRpdHk6IDMsXG4gICAgICAgICAgICBuYW1lOiBcItCU0LLRg9GF0L/QsNC70YPQsdC90LjQulwiLFxuICAgICAgICAgICAgY29vcmRzOiBbXVxuICAgICAgICB9LFxuICAgICAgICBvbmVHcmlkOiB7XG4gICAgICAgICAgICB3ZWlnaHQ6IDEsXG4gICAgICAgICAgICBxdWFudGl0eTogNCxcbiAgICAgICAgICAgIG5hbWU6IFwi0J7QtNC90L7Qv9Cw0LvRg9Cx0L3QuNC6XCIsXG4gICAgICAgICAgICBjb29yZHM6IFtdXG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5zZWFDb29yZHMgPSBbXTtcblxuICAgIHRoaXMuZW5lbXlHcmlkcyA9IFtdO1xuXG4gICAgdGhpcy54ID0gMTA7XG5cbiAgICB0aGlzLnkgPSAxMDtcblxuICAgIHRoaXMuZ2V0TmFtZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5uYW1lO1xuICAgIH07XG5cbiAgICB0aGlzLmdldFJvbGUgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucm9sZTtcbiAgICB9O1xuXG4gICAgdGhpcy5nZXRTaG9vdENvdW50ZXIgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2hvb3RDb3VudGVyO1xuICAgIH07XG5cbiAgICB0aGlzLnNldFNob290Q291bnRlciA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLnNob290Q291bnRlcisrO1xuICAgIH07XG5cbiAgICB0aGlzLmdldEZsZWV0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmZsZWV0O1xuICAgIH07XG5cbiAgICB0aGlzLmdldFggPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMueDtcbiAgICB9O1xuXG4gICAgdGhpcy5nZXRZID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnk7XG4gICAgfTtcblxuICAgIHRoaXMuZ2V0U2VhQ29vcmRzID0gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gdGhpcy5zZWFDb29yZHM7XG4gICAgfTtcblxuICAgIHRoaXMuYWRkU2VhQ29vcmRzID0gZnVuY3Rpb24oaSkge1xuICAgICAgICB0aGlzLnNlYUNvb3Jkcy5wdXNoKGkpO1xuICAgIH07XG5cbiAgICB0aGlzLnJlbW92ZVNlYUNvb3JkcyA9IGZ1bmN0aW9uKGkpIHtcbiAgICAgICAgdGhpcy5zZWFDb29yZHMuc3BsaWNlKGksMSk7XG4gICAgfTtcblxuICAgIHRoaXMuZ2V0RW5lbXlHcmlkcyA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5lbmVteUdyaWRzO1xuICAgIH07XG5cbiAgICB0aGlzLmFkZEVuZW15R3JpZHMgPSBmdW5jdGlvbihpKSB7XG4gICAgICAgIHRoaXMuZW5lbXlHcmlkcy5wdXNoKGkpO1xuICAgIH07XG5cbiAgICB0aGlzLnJlbW92ZUVuZW15R3JpZHMgPSBmdW5jdGlvbihpKSB7XG4gICAgICAgIHRoaXMuZW5lbXlHcmlkcy5zcGxpY2UoaSwxKTtcbiAgICB9O1xuXG4gICAgdGhpcy5pbml0UGxheWVyID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuY3JlYXRlR2FtZUZpZWxkKCk7XG4gICAgICAgIHRoaXMubG9jYXRlRmxlZXQoKTtcbiAgICB9O1xuXG4gICAgdGhpcy5jcmVhdGVHYW1lRmllbGQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgIHZhciB4U2l6ZSA9IHRoaXMuZ2V0WCgpLFxuICAgICAgICAgICAgIHlTaXplID0gdGhpcy5nZXRZKCk7XG5cbiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPD0geFNpemU7IGkrKykge1xuICAgICAgICAgICAgZm9yICh2YXIgaiA9IDE7IGogPD0geVNpemU7IGorKykge1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lZmllbGRfJyArIHRoaXMuZ2V0Um9sZSgpKS5pbm5lckhUTUwgKz0gJzxzcGFuIGNsYXNzPVwic2VhZ3JpZFwiIGlkPVwiJysgaSArICc6JysgaiArIFwiX1wiICsgdGhpcy5nZXRSb2xlKCkrJ1wiPjwvc3Bhbj4nO1xuICAgICAgICAgICAgICAgIHRoaXMuYWRkU2VhQ29vcmRzKGkrXCI6XCIraik7XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRSb2xlKCkgPT09ICdjb21wJykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZEVuZW15R3JpZHMoaStcIjpcIitqKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5sb2NhdGVGbGVldCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgJHNlbGYgPSB0aGlzLFxuICAgICAgICAgICAgZmxlZXQgPSAkc2VsZi5nZXRGbGVldCgpLFxuICAgICAgICAgICAgaywgb2JqLFxuICAgICAgICAgICAgYnVzeUNvb3Jkc0FycmF5ID0gW107XG5cbiAgICAgICAgLy8gcnVuIG92ZXIgZmxlZXQgb2JqZWN0XG4gICAgICAgIGZvciAoayBpbiBmbGVldCkge1xuICAgICAgICAgICAgb2JqID0gZmxlZXRba107XG5cbiAgICAgICAgICAgIC8vIHJ1biBvdmVyIHNoaXBzIG9uIGZsZWV0XG4gICAgICAgICAgICBmb3IgKHZhciB0ID0gMDsgdCA8IG9iai5xdWFudGl0eTsgdCsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNoaXBDb29yZHMgPSBnZW5lcmF0ZUNvb3JkcygpOyAvLyByZXN1bHQgY29vcmRzIGZvciBzaGlwXG4gICAgICAgICAgICAgICAgb2JqLmNvb3Jkcy5wdXNoKHNoaXBDb29yZHNbMF0pO1xuXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgbSBpbiBzaGlwQ29vcmRzWzFdKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0cmlnZ2VyID0gYnVzeUNvb3Jkc0FycmF5LmluZGV4T2Yoc2hpcENvb3Jkc1sxXVttXSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0cmlnZ2VyID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnVzeUNvb3Jkc0FycmF5LnB1c2goc2hpcENvb3Jkc1sxXVttXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjbGVhblNlYUNvb3JkcyhzaGlwQ29vcmRzKTtcblxuICAgICAgICAgICAgICAgIGlmKCRzZWxmLmdldFJvbGUoKSA9PT0gJ3VzZXInKSB7XG4gICAgICAgICAgICAgICAgICAgIGRyYXdGbGVldChzaGlwQ29vcmRzWzBdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBnZW5lcmF0ZSBjb29yZHNcbiAgICAgICAgZnVuY3Rpb24gZ2VuZXJhdGVDb29yZHMoKSB7XG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gW10sXG4gICAgICAgICAgICAgICAgdmFsaWRhdGVQb3NpdGlvbiA9IGZhbHNlO1xuXG4gICAgICAgICAgICBkbyB7XG4gICAgICAgICAgICAgICAgLy8gY3JlYXRlIHNoaXAgY29vcmRzIGFuZCBidXN5IGNvb3Jkc1xuICAgICAgICAgICAgICAgIHZhciBjcmVhdGVkUG9zaXRpb24gPSBjcmVhdGVTdGFydFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgIHRlbXBDb29yZHMgPSBjcmVhdGVDb29yZHMoY3JlYXRlZFBvc2l0aW9uKTtcblxuICAgICAgICAgICAgICAgIC8vIHZhbGlkYXRlIGNvb3JkcyBmb3Igc2hpcCBsb2NhdGlvblxuICAgICAgICAgICAgICAgIHZhbGlkYXRlUG9zaXRpb24gPSBjaGVja0Nvb3Jkcyh0ZW1wQ29vcmRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHdoaWxlKHZhbGlkYXRlUG9zaXRpb24gPT09IGZhbHNlKTtcblxuICAgICAgICAgICAgaWYgKHZhbGlkYXRlUG9zaXRpb24gPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0ZW1wQ29vcmRzWzBdLCB0ZW1wQ29vcmRzWzFdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH1cblxuICAgICAgICAvLyByYW5kb21pc2Ugc3RhcnQgcG9zaXRpb25cbiAgICAgICAgZnVuY3Rpb24gY3JlYXRlU3RhcnRQb3NpdGlvbigpIHtcbiAgICAgICAgICAgIHZhciBkaXJlY3Rpb24gPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyKSwgLy8gMCAtIGRyYXcgc2hpcCBob3Jpem9udGFsOyAxIC0gZHJhdyBzaGlwIHZlcnRpY2FsXG4gICAgICAgICAgICAgICAgcG9zSW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoKCRzZWxmLmdldFNlYUNvb3JkcygpLmxlbmd0aC0xKSArIDEpKSwgLy8gYXJyYXkgaW5kZXhcbiAgICAgICAgICAgICAgICBwb3NpdGlvbiA9ICRzZWxmLmdldFNlYUNvb3JkcygpW3Bvc0luZGV4XTsgLy8gdmFsdWUgb24gdGhpcyBpbmRleFxuXG4gICAgICAgICAgICByZXR1cm4gW3Bvc2l0aW9uLCBkaXJlY3Rpb25dO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gY2FsY3VsYXRlIHNoaXAgY29vcmRzXG4gICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNvb3JkcyhzdGFydERhdGEpIHtcbiAgICAgICAgICAgIHZhciB0ZW1wU2hpcENvb3JkcyA9IFtdLFxuICAgICAgICAgICAgICAgIHRlbXBCdXN5Q29vcmRzID0gY3JlYXRlQnVzeUNvb3JkcyhzdGFydERhdGEpLFxuICAgICAgICAgICAgICAgIHN0YXJ0QXJyID0gc3RhcnREYXRhWzBdLnNwbGl0KFwiOlwiKSxcbiAgICAgICAgICAgICAgICB4UG9zID0gcGFyc2VJbnQoc3RhcnRBcnJbMF0pLFxuICAgICAgICAgICAgICAgIHlQb3MgPSBwYXJzZUludChzdGFydEFyclsxXSksXG4gICAgICAgICAgICAgICAgZGlyID0gc3RhcnREYXRhWzFdO1xuXG4gICAgICAgICAgICBmb3IgKHZhciBzPTA7IHMgPCBvYmoud2VpZ2h0OyBzKyspIHtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGRpcikge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgeCA9IHhQb3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeSA9IHlQb3MgKyBzO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZW1wU2hpcENvb3Jkcy5wdXNoKHggKyBcIjpcIiArIHkpOyAvLyB2YWx1ZXMgYXJyYXlcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDA6XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgeCA9IHhQb3MgKyBzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHkgPSB5UG9zO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZW1wU2hpcENvb3Jkcy5wdXNoKHggKyBcIjpcIiArIHkpOyAvLyB2YWx1ZXMgYXJyYXlcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBbdGVtcFNoaXBDb29yZHMsIHRlbXBCdXN5Q29vcmRzXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUJ1c3lDb29yZHMoaSkge1xuICAgICAgICAgICAgdmFyIHRlbXBEZWFkQ29vcmRzPVtdLFxuICAgICAgICAgICAgICAgIHN0YXJ0QXJyID0gaVswXS5zcGxpdChcIjpcIiksXG4gICAgICAgICAgICAgICAgeCA9IHBhcnNlSW50KHN0YXJ0QXJyWzBdKSxcbiAgICAgICAgICAgICAgICB5ID0gcGFyc2VJbnQoc3RhcnRBcnJbMV0pLFxuICAgICAgICAgICAgICAgIGRpciA9IGlbMV07Ly8gMCAtIGRyYXcgc2hpcCBob3Jpem9udGFsOyAxIC0gZHJhdyBzaGlwIHZlcnRpY2FsXG5cbiAgICAgICAgICAgIGZvciAodmFyIHM9MDsgcyA8IG9iai53ZWlnaHQ7IHMrKykge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAoZGlyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHg+MSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcERlYWRDb29yZHMucHVzaCh4LTErXCI6XCIrKHkrcykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoeDwxMCkgdGVtcERlYWRDb29yZHMucHVzaCh4KzErXCI6XCIrKHkrcykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYocz09MCAmJiB4Pj0xICYmIHk+MSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcERlYWRDb29yZHMucHVzaCh4K1wiOlwiKyh5LTEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4PjEpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wRGVhZENvb3Jkcy5wdXNoKHgtMStcIjpcIisoeS0xKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHg8MTApIHRlbXBEZWFkQ29vcmRzLnB1c2goeCsxK1wiOlwiKyh5LTEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHMgPT09IG9iai53ZWlnaHQtMSAmJiB5PDEwLXMpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBEZWFkQ29vcmRzLnB1c2goeCtcIjpcIisoKHkrcykrMSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHg+MSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBEZWFkQ29vcmRzLnB1c2goKHgtMSkrXCI6XCIrKCh5K3MpKzEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeDwxMCkgdGVtcERlYWRDb29yZHMucHVzaCgoeCsxKStcIjpcIisoKHkrcykrMSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgY2FzZSAwOlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYoeT4xKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wRGVhZENvb3Jkcy5wdXNoKCh4K3MpK1wiOlwiKyh5LTEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHk8MTApIHRlbXBEZWFkQ29vcmRzLnB1c2goKHgrcykrXCI6XCIrKHkrMSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYocyA9PT0gMCAmJiB4PjEgJiYgeT49MSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcERlYWRDb29yZHMucHVzaCh4LTErXCI6XCIrKHkpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5PjEpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wRGVhZENvb3Jkcy5wdXNoKCh4LTEpK1wiOlwiKyh5LTEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeTwxMCkgdGVtcERlYWRDb29yZHMucHVzaCgoeC0xKStcIjpcIisoeSsxKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihzID09PSBvYmoud2VpZ2h0LTEgJiYgeDwxMC1zKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wRGVhZENvb3Jkcy5wdXNoKCh4K3MpKzErXCI6XCIrKHkpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5PjEpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wRGVhZENvb3Jkcy5wdXNoKCh4K3MpKzErXCI6XCIrKHktMSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5PDEwKXRlbXBEZWFkQ29vcmRzLnB1c2goKHgrcykrMStcIjpcIisoeSsxKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGVtcERlYWRDb29yZHM7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB2YWxpZGF0b3IgZm9yIGNyZWF0ZWQgY29vcmRzXG4gICAgICAgIGZ1bmN0aW9uIGNoZWNrQ29vcmRzKGRhdGEpIHtcbiAgICAgICAgICAgIHZhciB2YWxpZGF0b3IgPSBmYWxzZSxcbiAgICAgICAgICAgICAgICB0ZXN0U2hpcERvdHMgPSBbXSxcbiAgICAgICAgICAgICAgICB0ZXN0QnVzeURvdHMgPSBbXSxcbiAgICAgICAgICAgICAgICB2YWxpZF9zaGlwLFxuICAgICAgICAgICAgICAgIHZhbGlkX2Fyb3VuZDtcblxuICAgICAgICAgICAgZm9yICh2YXIgayBpbiBkYXRhWzBdKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNvb3JkID0gJHNlbGYuZ2V0U2VhQ29vcmRzKCkuaW5kZXhPZihkYXRhWzBdW2tdKSxcbiAgICAgICAgICAgICAgICAgICAgYnVzeURvdCA9IGJ1c3lDb29yZHNBcnJheS5pbmRleE9mKGRhdGFbMF1ba10pOyAvL3ZhbHVlXG5cbiAgICAgICAgICAgICAgICB0ZXN0U2hpcERvdHMucHVzaChjb29yZCk7XG4gICAgICAgICAgICAgICAgdGVzdEJ1c3lEb3RzLnB1c2goYnVzeURvdCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciBpc192YWxpZCA9IGZ1bmN0aW9uKG4pIHsgcmV0dXJuIG4gPT0gLTE7IH07XG5cbiAgICAgICAgICAgIHZhbGlkX3NoaXAgPSB0ZXN0U2hpcERvdHMuc29tZShpc192YWxpZCk7XG4gICAgICAgICAgICB2YWxpZF9hcm91bmQgPSB0ZXN0QnVzeURvdHMuc29tZShpc192YWxpZCk7XG5cbiAgICAgICAgICAgIGlmICh2YWxpZF9zaGlwID09PSBmYWxzZSAmJiB2YWxpZF9hcm91bmQgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICB2YWxpZGF0b3IgPSB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YWxpZGF0b3IgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRvcjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGRlbGV0ZSBidXN5IGNvb3JkcyBmcm9tIHNlYUNvb3JkcyBBcnJheVxuICAgICAgICBmdW5jdGlvbiBjbGVhblNlYUNvb3JkcyhkYXRhKSB7XG4gICAgICAgICAgICB2YXIgc2hpcENvb3JkcyA9IGRhdGFbMF0sXG4gICAgICAgICAgICAgICAgYnVzeUNvb3JkcyA9IGRhdGFbMV07XG5cbiAgICAgICAgICAgIGRlbGV0ZXIoc2hpcENvb3JkcyxidXN5Q29vcmRzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGRlbGV0ZXIoKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBtIGluIGFyZ3VtZW50cykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGsgaW4gYXJndW1lbnRzW21dKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjb29yZHNBcnJheSA9ICRzZWxmLmdldFNlYUNvb3JkcygpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZG90ID0gY29vcmRzQXJyYXkuaW5kZXhPZihhcmd1bWVudHNbbV1ba10pO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChkb3QgIT09IC0xKSAkc2VsZi5yZW1vdmVTZWFDb29yZHMoZG90KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBkcmF3IGZsZWV0IG9uIHNlYWZpZWxkXG4gICAgICAgIGZ1bmN0aW9uIGRyYXdGbGVldChpKSB7XG5cbiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBpKSB7XG4gICAgICAgICAgICAgICAgdmFyIGdyaWRJZCA9IGlba2V5XStcIl9cIiskc2VsZi5nZXRSb2xlKCk7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZ3JpZElkKS5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcInNoZWVwXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfTtcbn0iLCIoZnVuY3Rpb24oKXtcblxuICAgIHZhciBnYW1lID0gbmV3IEdhbWUoKTtcblxuICAgIGdhbWUuc3RhcnRHYW1lKCk7XG5cbn0oKSk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
